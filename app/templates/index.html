<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DevBrew âšª Cloudflare Downloader</title>
  <style>
    :root { color-scheme: dark; }
    body { 
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      max-width: 800px; 
      margin: 2rem auto; 
      padding: 0 1rem; 
      color: #eee; 
      background: #0a0a0a;
    }
    header { margin-bottom: 1.25rem; }
    input[type="url"] { 
      width: 100%; 
      padding: .65rem .75rem; 
      border-radius: .5rem; 
      border: 1px solid #444; 
      background: #111; 
      color: #eee;
      font-size: 1rem;
    }
    button { 
      padding: .6rem .9rem; 
      border-radius: .5rem; 
      border: 1px solid #444; 
      background: #1b1b1b; 
      color: #eee; 
      cursor: pointer;
      font-size: .95rem;
    }
    button:hover { background: #222; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .row { display: flex; gap: .5rem; align-items: center; margin-top: .75rem; }
    .card { 
      border: 1px solid #333; 
      background: #141414; 
      padding: 1rem; 
      border-radius: .75rem; 
      margin-top: 1rem; 
    }
    .muted { color: #9aa0a6; font-size: .95rem; }
    .ok { color: #8bd48b; }
    .error { color: #ff6b6b; }
    .warning { color: #ffa500; }
    .mono { font-family: monospace; }
    .spinner { 
      display: inline-block; 
      width: 14px; 
      height: 14px; 
      border: 2px solid #444; 
      border-top-color: #8bd48b; 
      border-radius: 50%; 
      animation: spin 0.8s linear infinite;
      margin-left: 0.5rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .status-queued { background: #3a3a00; color: #ffeb3b; }
    .status-downloading { background: #003a3a; color: #4fc3f7; }
    .status-retrying { background: #3a2f00; color: #ffcc66; }
    .status-completed { background: #003a00; color: #8bd48b; }
    .status-failed { background: #3a0000; color: #ff6b6b; }
  </style>
</head>
<body>
  <header style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
      <h1>DevBrew âšª Cloudflare Downloader</h1>
      <p class="muted">FÃ¼ge eine oder mehrere URLs ein (eine pro Zeile) und starte den Download.</p>
    </div>
    <a href="/gallery" style="padding: .6rem .9rem; border-radius: .5rem; border: 1px solid #444; background: #1b1b1b; color: #eee; text-decoration: none; font-size: .95rem; display: inline-flex; align-items: center; gap: 0.5rem;">
      Galerie <span>ðŸ“‚</span>
    </a>
  </header>

  <form id="downloadForm" onsubmit="handleSubmit(event)">
    <label for="u" class="muted">Video-URLs</label>
    <textarea id="u" name="u" rows="5" placeholder="https://youtube.com/watch?v=...&#10;https://youtu.be/..." required style="width: 100%; padding: .65rem .75rem; border-radius: .5rem; border: 1px solid #444; background: #111; color: #eee; font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
    <div class="row">
      <button type="submit" id="submitBtn">Downloads starten</button>
    </div>
  </form>

  <div id="queueSection" style="margin-top: 2rem; display: none;">
    <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">Download Queue</h2>
    <div id="queueContainer"></div>
  </div>

  <script>
    // State to track jobs: { id: "job-uuid", url: "...", status: "...", error: "..." }
    let jobs = [];

    // Load jobs from localStorage on startup
    try {
      const stored = localStorage.getItem("devbrew_dl_jobs");
      if (stored) {
        jobs = JSON.parse(stored);
        // Clean up very old jobs (optional, e.g. > 24h)
        const cutoff = Date.now() - 24 * 60 * 60 * 1000;
        jobs = jobs.filter(j => !j.timestamp || j.timestamp > cutoff);
      }
    } catch (e) {
      console.error("Failed to load jobs", e);
    }

    // Check for server-injected job (Quicklink or single submission)
    const serverJobId = "{{ job_id }}";
    const serverUrl = "{{ url|e }}";
    const serverFeedback = "{{ feedback|e }}";

    if (serverJobId && serverUrl) {
      // Check if we already have this job
      const exists = jobs.find(j => j.realId === serverJobId);
      if (!exists) {
        const newJob = {
          id: "server-" + serverJobId,
          realId: serverJobId,
          url: serverUrl,
          status: "queued", // Assume queued initially
          error: null,
          timestamp: Date.now()
        };
        jobs.unshift(newJob);
        saveJobs();
      }
    }

    // Initial render and poll
    if (jobs.length > 0) {
      document.getElementById("queueSection").style.display = "block";
      renderQueue();
      // Resume polling for active jobs
      jobs.forEach(job => {
        if (job.status !== "completed" && job.status !== "failed") {
          pollJob(job);
        }
      });
    }

    function saveJobs() {
      try {
        localStorage.setItem("devbrew_dl_jobs", JSON.stringify(jobs));
      } catch (e) {
        console.error("Failed to save jobs", e);
      }
    }

    async function handleSubmit(event) {
      event.preventDefault();
      
      const textarea = document.getElementById("u");
      const rawInput = textarea.value.trim();
      if (!rawInput) {
        alert("Bitte mindestens eine URL eingeben");
        return;
      }

      const urls = rawInput.split(/\n+/).map(u => u.trim()).filter(u => u.length > 0);
      if (urls.length === 0) return;

      // Clear input
      textarea.value = "";

      // Show queue section
      document.getElementById("queueSection").style.display = "block";

      // Process each URL
      for (const url of urls) {
        await startJob(url);
      }
    }

    async function startJob(url) {
      // Create a temporary ID for the UI before we get the real one
      const tempId = "temp-" + Date.now() + "-" + Math.random().toString(36).substr(2, 9);
      
      const job = {
        id: tempId,
        realId: null,
        url: url,
        status: "starting",
        error: null,
        timestamp: Date.now()
      };
      
      jobs.unshift(job); // Add to top
      saveJobs();
      renderQueue();

      try {
        const res = await fetch("/download", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ u: url })
        });

        const data = await res.json();

        if (data.ok) {
          job.realId = data.job_id;
          job.status = "queued";
          saveJobs();
          // Start polling for this job
          pollJob(job);
        } else {
          job.status = "failed";
          job.error = data.error || "Unbekannter Fehler";
          saveJobs();
        }
      } catch (error) {
        job.status = "failed";
        job.error = "Netzwerkfehler: " + error.message;
        saveJobs();
      }
      
      renderQueue();
    }

    function renderQueue() {
      const container = document.getElementById("queueContainer");
      container.innerHTML = "";

      jobs.forEach(job => {
        const card = document.createElement("div");
        card.className = "card";
        
        let statusClass = "muted";
        if (job.status === "queued") statusClass = "status-queued";
        if (job.status === "downloading") statusClass = "status-downloading";
        if (job.status === "retrying") statusClass = "status-retrying";
        if (job.status === "completed") statusClass = "status-completed";
        if (job.status === "failed") statusClass = "status-failed";

        let html = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${job.url}">
                ${job.url}
              </div>
              <div style="margin-top: 0.5rem;">
                <span class="status-badge ${statusClass}">${job.status.toUpperCase()}</span>
                ${job.realId ? `<span class="mono muted" style="font-size: 0.8em; margin-left: 0.5rem;">${job.realId}</span>` : ''}
              </div>
              ${job.error ? `<div class="error" style="margin-top: 0.5rem; font-size: 0.9em;">${job.error}</div>` : ''}
            </div>
          </div>
        `;
        
        card.innerHTML = html;
        container.appendChild(card);
      });
    }

    function pollJob(job) {
      if (!job.realId) return;

      const interval = setInterval(async () => {
        try {
          const res = await fetch(`/api/status/${job.realId}`);
          const data = await res.json();

          if (data.ok) {
            job.status = data.job.status;
            if (data.job.error) job.error = data.job.error;
            
            saveJobs();
            renderQueue();

            if (job.status === "completed" || job.status === "failed") {
              clearInterval(interval);
            }
          }
        } catch (e) {
          console.error("Polling error", e);
        }
      }, 2000);
    }
  </script>
</body>
</html>
